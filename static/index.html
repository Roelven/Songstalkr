<!DOCTYPE html>
<html>
<head>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

  <meta charset=utf-8 />

  <title>Friendslistenr</title>

</head>

<body>

<div class="wrapper">
  <ul class="friends">
    <li>
      <span class="username">Roelven</span>
      <div class="listening">
        <span class="listeningnow"></span><a class="song" href="#"></a>
      </div>
    </li>
    <li>
      <span class="username">Spietsch</span>
      <div class="listening">
        <span class="listeningnow"></span><a class="song" href="#"></a>
      </div>
    </li>
    <li>
      <span class="username">Matisas</span>
      <div class="listening">
        <span class="listeningnow"></span><a class="song" href="#"></a>
      </div>
    </li>

  </ul>

</div>

<script type="text/javascript">
  $(function() {
    var lastfm_api_key = '3907fcb3081064975fec30a3225e3288';

    function searchTrack(song, friendobject) {
      console.log('searching Spotify for "' + song + '" ...');

      $.ajax({
        type: 'GET',
        url: 'http://ws.spotify.com/search/1/track?q=' + song,
        processData: true,
        dataType: 'xml',
        success: function(spotiresult) {
          var spotilink = $(spotiresult).find('track').first().attr('href');
          console.log(spotilink);
          friendobject.find('.song').attr('href', spotilink);
          return false;
        }
      });
      return false;
    };

    function getTrack(api_key, username, song, friendobject) {
      console.log('Pinging Last.fm for "' + username.html() + '" ... ');
  		$.ajax({
  			type: 'GET',
  			processData: true,
  			url: 'http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user='+ username.html() +'&api_key='+ api_key +'&format=json&limit=1',
  			dataType: 'jsonp',
  			success: function(results) {
  			  var track = results.recenttracks.track;
  			  var artist = results.recenttracks.track.artist['#text'];
          console.log('Song: '+ track.name);
          song.html(artist + ' - ' + track.name);
  				return searchTrack(track.name, friendobject);
  			}
  		});
  		return false;
    };
    
    $('.friends li').each(function() {
      var username = $(this).find('.username');
      var song = $(this).find('.song');
      getTrack(lastfm_api_key, username, song, $(this));
    });
  });
</script>

</body>

</html>â€‹